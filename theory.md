ACS
Система, которая может отправлять конфигурации на устройство и проверять, сконфигурированы устройства или нет
Состоит из:
- CPE Wan Management  Protocol
	- протокол работает только с устройствами, на которых есть порт TR-069 (technical report 69, технический отчет 69), который говорит прикладному уровню управлять конфигурацией устройства.
	- создан для автоматического управления и автоматической конфигурации устройств.
	- основан на Soap/HTTP
	- безопасность
		- аутентификация 
		- пароль пользователя
		- ssl
		- сертификаты для клиентов
- Auto Configuration Server
	- сессия начинается в ответ на события, например перезагрузку или включение
	- сервер никогда не может начать сессию, только попросить CPE начать сессию
- удаленное оборудование отправляет Inform RPC на сервер, в котором содержится причина события и информация об устройстве
	- основан на параметрах: key = value
	- набор параметров, поддерживаемых производителем называют моделью данных.
		- есть три стандарта модели данных:
			- TR-098
			- TR-181:1
			- TR-181:2
- производитель должен основывать свою модель данных на стандарте - его модель данных должна содержать все данные или подмножество из стандарта
GenieACS 
- open source
- fast
- node.js и mongoDB
Для установки необходимо:
node.js (с 6 по 8)
mongodb (c 2.6 по 3.4)
build tools
библиотека libxml2

На node.js пишутся скрипты провижининга, например этот скрипт переносит конфигурацию из файла "****FILENAME****.alter" . Скрипты идентифицируются по имени.
```js
let now = Date.now(); 
declare("Downloads.[FileType:3 Vendor Configuration File]",
    {path: 1}, {path: 1});
  declare("Downloads.[FileType:3 Vendor Configuration File].FileName",
    {value: 1}, {value: "****FILENAME****.alter"});
  declare("Downloads.[FileType:3 Vendor Configuration File].Download",
    {value: 1}, {value: Date.now});
```

Провизия - это фрагмент JavaScript-кода, выполняемый на сервере для каждого устройства. Он позволяет реализовывать сложные сценарии настройки и другие операции, такие как автоматическое развертывание обновления прошивки.
Скрипты выполняются в случае выполнения события. Прописывается preset, в котором указывается имя скрипта провижининга, событие, при котором он должен запускаться, а также преднастройки.
```js
Preset
Name: Имя пресета
Events: 1 BOOT
Precondition:
	Provision Code = AP-UP
Configurations:
Provision name: Имя скрипта 	
Save
```
GenieACS хранит копию параметров из  Inform RPC (причина события и информация об устройстве) в базе данных Mongo. 
Мы делаем запросы к базе данных через API. GenieACS делает запросы к клиенту CPE через cwmp. 
Нам также нужно отправлять Refresh RPC на genieACS, чтобы получать последнюю информацию и проверять работоспособность.

Встроенные функции GenieACS CWMP
1. declare(path, timestamps, values):
Назначение: Объявить значения параметров для установки на устройстве.
Параметры:
- path: Путь к параметру, к которому хотите получить доступ или установить. Поддерживаются подстановочные знаки.
- timestamps: Объект, указывающий желаемую временную метку обновления для разных атрибутов.
Возможные значения атрибутов timestamps и values:
- value: Временная метка для самого значения параметра (необязательно, тип может быть выведен).
- writable: Временная метка для информации о возможности записи (значение зависит от типа параметра).
- object: Временная метка для информации об объекте/экземпляре.
- path: Временная метка для обнаружения экземпляров объектов с использованием подстановочных знаков.
- values: Объект, содержащий фактические значения, которые нужно установить.
Значение может быть простым значением или парой типа ([<value>, <type>]).
Возвращаемое значение: Итератор для доступа к параметрам, соответствующим пути.
Пример: Настройка SSID на основе последних 6 символов серийного номера.
2. clear(path, timestamp):
Назначение: Сделать кешированные данные параметров в базе данных недействительными.
Параметры:
path: Путь к параметрам, которые хотите очистить.
timestamp: Временная метка, представляющая минимальное время обновления для сохранения данных.
Полезно: Гарантирует наличие последних данных после событий, таких как сброс к заводским настройкам.
3. commit():
Назначение: Выполнить фиксацию ожидающих объявлений и синхронизацию с устройством (при необходимости).
Обычно вызывается неявно, но вы можете вызвать его явно, чтобы контролировать порядок конфигурации.
4. ext(file, function, arg1, arg2, ...):
Назначение: Позволяет выполнять расширения сценариев и вызывать функции в них.
Параметры:
file: Имя файла расширения сценария.
function: Имя функции, которую нужно вызвать в сценарии.
arg1, arg2, ...: Дополнительные аргументы, передаваемые функции.
Обратитесь к документации genieacs-cwmp для получения подробностей о расширениях.
5. log(message):
Назначение: Используется для целей отладки.
Печатает сообщение в журнал доступа genieacs-cwmp.
Формат пути параметров (Path format)
Формат пути параметров в genieacs-cwmp позволяет указать конкретный параметр или группу параметров на устройстве. Он может включать подстановочные знаки (*) и фильтры по псевдонимам ([name:value]).
1. Подстановочные знаки (*)
Подстановочный знак * в пути параметра применяется к одному или нескольким параметрам, соответствующим указанному пути.
Подстановочный знак может использоваться в любом сегменте пути.
Пример:
Device.LANDevice.*.IPAddress


Этот путь будет соответствовать всем параметрам IPAddress внутри объектов LANDevice устройства, независимо от их конкретного номера (например, Device.LANDevice.1.IPAddress, Device.LANDevice.2.IPAddress и т.д.).
2. Фильтры по псевдонимам ([name:value])
Фильтр по псевдониму похож на подстановочный знак, но он дополнительно выполняет фильтрацию дочерних параметров на основе предоставленных пар "ключ-значение".
Это позволяет указать конкретные параметры, даже если их номера экземпляров на разных устройствах отличаются.
Пример:
Device.WANDevice.1.WANConnectionDevice.1.WANIPConnection.[AddressingType:DHCP].ExternalIPAddress


Этот путь вернет список параметров ExternalIPAddress (0 или более), у которых соседний параметр AddressingType имеет значение "DHCP".
Возможности фильтров по псевдонимам:
Использование нескольких пар "ключ-значение" в одном фильтре.
Использование нескольких фильтров в одном пути.
Комбинирование фильтров и подстановочных знаков.
Создание/удаление экземпляров объектов
В GenieACS нельзя напрямую создавать или удалять экземпляры объектов. Вместо этого, указывается желаемое количество экземпляров, а GenieACS определяет необходимость их создания или удаления.
Пример:
declare("InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANIPConnection.*", null, {path: 1});


Этот код гарантирует наличие только одного объекта WANIPConnection (звездочка * - подстановочный знак).
Фильтры по псевдонимам позволяют указать нужные экземпляры по их свойствам.
Пример:
// Удалить все лишние экземпляры
declare("InternetGatewayDevice.X_BROADCOM_COM_IPAddrAccCtrl.X_BROADCOM_COM_IPAddrAccCtrlListCfg.[]", null, {path: 0});


// Добавить 2 нужных экземпляра
declare("...[SourceIPAddress:192.168.1.0,SourceNetMask:255.255.255.0]", {path: now}, {path: 1});
declare("...[SourceIPAddress:172.16.12.0,SourceNetMask:255.255.0.0]", {path: now}, {path: 1});


В данном примере фильтруются объекты по SourceIPAddress и SourceNetMask, а затем добавляются нужные.
Специальные параметры GenieACS
Помимо параметров модели данных устройства из TR-069, GenieACS имеет собственный набор специальных параметров:
DeviceID - Этот подпараметр содержит следующую информацию (только для чтения):
ID устройства
Серийный номер
Класс продукта
OUI
Производитель
Tags - Корневой параметр Tags используется для управления метками устройства. Метки представлены как дочерние параметры с логическими значениями (true/false). Установка значения метки в false удаляет ее, а true для несуществующей метки - создает ее.
Пример:
Удалить "tag1", добавить "tag2" и прочитать "tag3"
declare("Tags.tag1", null, {value: false});
declare("Tags.tag2", null, {value: true});
let tag3 = declare("Tags.tag3", {value: 1});


Reboot - Корневой параметр Reboot хранит временную метку последней перезагрузки. Значение параметра можно менять. Установка значения большего, чем текущее, перезагрузить устройство.
Пример:
Перезагрузить устройство, только если оно не перезагружалось за последние 300 секунд.
declare("Reboot", null, {value: Date.now() - (300 * 1000)});


FactoryReset - Работает аналогично Reboot, но для сброса к заводским настройкам.
Пример:
Сбросить устройство к заводским настройкам.
declare("FactoryReset", null, {value: Date.now()});


Downloads - Поддерево Downloads содержит информацию о последней команде загрузки. Каждая команда представлена экземпляром (например, Downloads.1) с параметрами, такими как Download (время), LastFileType, LastFileName. Параметры FileType, FileName, TargetFileName и Download можно менять для запуска новой загрузки.
Предупреждение:
Загрузка файла на устройство часто прерывает работу сервисов. Рекомендуется запускать ее только в определенных событиях (например, 1 BOOT или во время запланированного обслуживания).
После завершения загрузки и применения файла конфигурации устройство отправит событие 7 TRANSFER COMPLETE. Его можно использовать для перезагрузки после применения образа прошивки или файла конфигурации.
Виртуальные параметры GenieACS
Виртуальные параметры - это определяемые пользователем параметры, значения которых генерируются с помощью специального JavaScript-кода. Они ведут себя как обычные параметры и отображаются в модели данных по пути VirtualParameters.path.
Ключевые особенности:
Создание пользователем: Определяются пользователем для конкретных нужд.
Значения из кода: Величины генерируются на основе JavaScript-кода.
Поведение как обычные параметры: Взаимодействуют с системой как стандартные параметры.
Ограничения:
Отсутствие внешних аргументов: Нельзя передавать скрипту виртуального параметра дополнительные аргументы.
Обязательное возвращаемое значение: Скрипт должен вернуть объект с атрибутами этого параметра.
Использование:
Виртуальные параметры добавляются в модель данных вручную или через предустановки.
Пример: Универсальный MAC-адрес для разных моделей устройств
Этот код находит MAC-адрес из разных моделей устройств и возвращает его как виртуальный параметр.
let m = "00:00:00:00:00:00";
let d = declare("Device.WANDevice.*.WANConnectionDevice.*.WANIPConnection.*.MACAddress", {value: Date.now()});
let igd = declare("InternetGatewayDevice.WANDevice.*.WANConnectionDevice.*.WANPPPConnection.*.MACAddress", {value: Date.now()});

if (d.size) {
  for (let p of d) {
    if (p.value[0]) {
      m = p.value[0];
      break;
    }
  }
}
else if (igd.size) {
  for (let p of igd) {
    if (p.value[0]) {
      m = p.value[0];
      break;
    }
  }
}

return {writable: false, value: [m, "xsd:string"]};


Как это работает:
Инициализация:
m - переменная для хранения найденного MAC-адреса (изначально пустая строка).
Поиск MAC-адреса:
d - результат поиска MAC-адреса в объектах WANIPConnection.
igd - результат поиска MAC-адреса в объектах WANPPPConnection.
Цикл проверяет наличие значений MAC-адреса в найденных параметрах.
Если найден MAC-адрес, он сохраняется в переменную m.
Формирование результата:
Возвращается объект виртуального параметра:
writable: false - параметр только для чтения.
value: [m, "xsd:string"] - значение параметра (m) и его тип ("xsd:string").
Дополнительные примеры виртуальных параметров GenieACS
1. Внешнее значение как виртуальный параметр
let serial = declare("DeviceID.SerialNumber", {value: 1});
if (args[1].value) {
  ext("example-ext", "set", serial.value[0], args[1].value[0]);
  return {writable: true, value: [args[1].value[0], "xsd:string"]};
}
else {
  let v = ext("example-ext", "get", serial.value[0]);
  return {writable: true, value: [v, "xsd:string"]};
}


Этот пример демонстрирует получение значения из внешнего источника (функции ext) и отображение его как виртуального параметра.
Сначала скрипт получает серийный номер устройства.
Затем, в зависимости от наличия аргумента, он:
Сохраняет внешнее значение, связанное с серийным номером, с помощью функции ext("example-ext", "set").
Запрашивает внешнее значение по серийному номеру с помощью функции ext("example-ext", "get").
Наконец, формируется объект виртуального параметра с полученным или переданным значением.
2. Редактируемый виртуальный параметр для WPA-ключа
let m = "";
if (args[1].value) {
  m = args[1].value[0];
  declare("Device.WiFi.AccessPoint.1.Security.KeyPassphrase", null, {value: m});
  declare("InternetGatewayDevice.LANDevice.1.WLANConfiguration.1.KeyPassphrase", null, {value: m});
}
else {
  let d = declare("Device.WiFi.AccessPoint.1.Security.KeyPassphrase", {value: Date.now()});
  let igd = declare("InternetGatewayDevice.LANDevice.1.WLANConfiguration.1.KeyPassphrase", {value: Date.now()});

  if (d.size) {
    m = d.value[0];
  }
  else if (igd.size) {
    m = igd.value[0];
  }
}

return {writable: true, value: [m, "xsd:string"]};


Этот пример создает виртуальный параметр для WPA-ключа, который можно редактировать через веб-интерфейс.
Скрипт проверяет наличие аргумента с новым значением ключа.
Если аргумент есть, он устанавливает новое значение для параметров KeyPassphrase в объектах Device.WiFi.AccessPoint.1 и InternetGatewayDevice.LANDevice.1.WLANConfiguration.1.
Если аргумента нет, скрипт пытается получить текущее значение ключа из тех же объектов.
В любом случае, формируется объект виртуального параметра с текущим или новым значением ключа.
GenieACS Administration FAQ (Russian)
Часто задаваемые вопросы по администрированию GenieACS
Повторные записи в журнале при использовании функции log()
В GenieACS используется полноценный скриптовый язык для настройки устройств. Единственный способ гарантировать достижение желаемого состояния - многократное выполнение скрипта до тех пор, пока не исчезнут расхождения с текущим состоянием устройства.
Это не приведет к дублирующимся запросам к устройству, поскольку конфигурация устройства задается декларативно, а сами скрипты являются чистыми функциями в контексте сессии (например, Date.now() всегда возвращает одно и то же значение в сессии).
log("Выполнение скрипта");
declare("Device.param", null, {value: 1});
commit();
declare("Device.param", null, {value: 2});

Этот код установит значение параметра "Device.param" сначала в 1, затем в 2. При повторном запуске скрипта значение снова установится в 1 и т.д. Стабильного состояния никогда не будет достигнуто, поэтому GenieACS выполнит скрипт несколько раз, пока не откажется и не выдаст ошибку. Это крайний случай, которого следует избегать.
Обычно скрипт выполняется один или два раза. По сути, если выполнение не приводит к запросу на CPE или изменению модели данных, считается, что достигнуто стабильное состояние.
Настройки не передаются на устройство после сброса к заводским
После сброса устройства до заводских настроек необходимо очистить кешированную модель данных в базе данных GenieACS, чтобы принудительно выполнить повторное обнаружение. Убедитесь, что следующие строки вызываются при событии 0 BOOTSTRAP:
const now = Date.now();
// Очистить кешированную модель данных для принудительного обновления
clear("Device", now);
clear("InternetGatewayDevice", now);

Отсутствует большинство параметров устройства
Из соображений производительности (сервер, клиент и сеть) GenieACS по умолчанию извлекает только те части модели данных, которые необходимы для выполнения объявлений в ваших скриптах. Создайте объявления для любых параметров, которые вам нужно извлечь по умолчанию.
Если вы не уверены и хотите изучить доступные параметры, предоставляемые устройством, обновите корневой параметр (например, InternetGatewayDevice) из пользовательского интерфейса GenieACS. Обычно это нужно делать только один раз для конкретной модели CPE.
Расширения GenieACS
Ограничения песочницы
Provision'ы и виртуальные параметры выполняются в изолированной среде (песочнице). Они не могут напрямую взаимодействовать с внешними источниками или файловой системой.
Расширения - Решение
Расширения - полнофункциональные Node.js модули, имеющие доступ к стандартным библиотекам и сторонним пакетам. Функции расширений вызываются из скриптов Provision'ов с помощью функции ext().
Пример использования:
Получение учетных данных из базы данных для передачи на устройство во время настройки.
Размещение расширений
По умолчанию код расширения JS должен располагаться в каталоге config/ext.
Пример расширения:
// This is an example GenieACS extension to get the current latitude/longitude
// of the International Space Station. Why, you ask? Because why not.
// To install, copy this file to config/ext/iss.js.

"use strict";

const http = require("http");

let cache = null;
let cacheExpire = 0;

function latlong(args, callback) {
  if (Date.now() < cacheExpire) return callback(null, cache);

  http
    .get("http://api.open-notify.org/iss-now.json", (res) => {
      if (res.statusCode !== 200)
        return callback(
          new Error(`Request failed (status code: ${res.statusCode})`),
        );

      let rawData = "";
      res.on("data", (chunk) => (rawData += chunk));

      res.on("end", () => {
        let pos = JSON.parse(rawData)["iss_position"];
        cache = [+pos["latitude"], +pos["longitude"]];
        cacheExpire = Date.now() + 10000;
        callback(null, cache);
      });
    })
    .on("error", (err) => {
      callback(err);
    });
}

exports.latlong = latlong;


Этот пример получает данные с внешнего REST API и возвращает их вызывающей стороне.
Как это работает?
Расширение кеширует данные о широте и долготе МКС, полученные с внешнего API.
Скрипт Provision вызывает функцию latlong() расширения для получения данных.
Если данные есть в кеше (не устарели), расширение возвращает их не обращаясь к API снова.
Если кеш пуст или устарел, расширение вызывает внешний API, обновляет кеш и возвращает данные.
Использование в скрипте:
const res = ext("ext-sample", "latlong", "arg1", "arg2");
log(JSON.stringify(res));

В данном примере аргументы "arg1" и "arg2" передаются в latlong, но не используются.
GenieACS API
curl 'http://yourACS:7557/faults/' 20 -X GET ; echo

GenieACS предоставляет RESTful API для управления устройствами через NBI-компонент.
API использует язык запросов MongoDB.
Замечания:
Примеры используют команду curl (для простоты).
URL запросы требуют правильной кодировки спецсимволов.
Структура конечной точки:
GET /<collection>/?query=<query>&projection=<projection (optional)>

Поддерживаемые функции:
Поиск записей в базе данных по запросу.
Получение данных, соответствующих запросу в формате JSON.
Получение определенных данных для записи с помощью проекций.
Параметры:
<collection>: Имя коллекции данных для поиска (например, устройства, задачи).
<query>: Строка запроса MongoDB, определяющая критерии поиска. Подробную информацию о синтаксисе запросов см. в документации MongoDB.
<projection> (необязательно): Список разделенных запятыми конкретных полей, которые нужно получить для каждой совпадающей записи.
Примеры:
Найти устройство по ID:
Запрос: {"_id": "202BC1-BM632w-000000"}
curl -i 'http://localhost:7557/devices/?query=%7B%22_id%22%3A%22202BC1-BM632w-000000%22%7D'

Найти устройства, которые не сообщали о себе в течение 7 дней:
Запрос: {"_lastInform": {"$lt": "2017-12-11 13:16:23 +0000"}}
Показать ожидающие задачи для устройства:
Запрос: {"device": "202BC1-BM632w-000000"}
Получить сведения о модели и производителе устройства:
Запрос: {"_id": "202BC1-BM632w-000000"}
Проекция: InternetGatewayDevice.DeviceInfo.ModelName,InternetGatewayDevice.DeviceInfo.Manufacturer
curl -i 'http://localhost:7557/devices?query=%7B%22_id%22%3A%22202BC1-BM632w-000000%22%7D&projection=InternetGatewayDevice.DeviceInfo.ModelName,InternetGatewayDevice.DeviceInfo.Manufacturer'

 Параметр URL projection представляет собой список разделенных запятыми параметров, которые вы хотите получить в ответе.
POST /devices/<device_id>/tasks?[connection_request] (на русском)

Этот запрос позволяет добавлять задачи на устройство и (необязательно) запрашивать немедленное подключение к нему. 
Запрос возвращает код состояния 200, если задача успешно выполнена, и 202, если она поставлена в очередь на выполнение при следующем информировании.
device_id: Уникальный идентификатор устройства.
connection_request (необязательно): Параметр указывает, следует ли отправлять запрос на подключение к устройству для немедленного выполнения задач. Если параметр не указан, задачи будут добавлены в очередь и выполнены при следующем сеансе связи с устройством.
Тело ответа: Объект задачи в том виде, в каком он был добавлен в базу данных. Объект будет содержать свойство _id, которое можно использовать для дальнейшего поиска задачи.
Примеры:
Найти устройство по ID:
Обновить все параметры устройства сейчас
curl -i 'http://localhost:7557/devices/202BC1-BM632w-000000/tasks?connection_request' \
-X POST \
--data '{"name": "refreshObject", "objectName": ""}'


Поменять WiFi SSID и password
Запрос: {
  "name": "setParameterValues",
  "parameterValues": [
    ["InternetGatewayDevice.LANDevice.1.WLANConfiguration.1.SSID", "GenieACS", "xsd:string"],
    ["InternetGatewayDevice.LANDevice.1.WLANConfiguration.1.PreSharedKey.1.PreSharedKey", "hello world", "xsd:string"]
  ]
}
curl -i 'http://localhost:7557/devices/202BC1-BM632w-000000/tasks?connection_request' \


POST /tasks/<task_id>/retry

Повторно выполнить неисправную задачу при следующем сеансе связи с устройством.
task_id: Уникальный идентификатор задачи, полученный с помощью запроса GET /tasks.
Пример:
curl -i 'http://localhost:7557/tasks/5403908ef28ea3a25c138adc/retry' -X POST


DELETE /tasks/<task_id>

Удалить указанную задачу.
task_id: Уникальный идентификатор задачи, полученный с помощью запроса GET /tasks.
Пример:
curl -i 'http://localhost:7557/tasks/5403908ef28ea3a25c138adc' -X DELETE


DELETE /faults/<fault_id>

Удалить указанную ошибку.
fault_id: Уникальный идентификатор ошибки, полученный с помощью запроса GET /faults. Формат идентификатора: "<device_id>:<channel>".
Пример:
curl -i 'http://localhost:7557/faults/202BC1-BM632w-000000:default' -X DELETE


DELETE /devices/<device_id>

Удалить указанное устройство из базы данных.
device_id: Уникальный идентификатор устройства.
Пример:
curl -X DELETE -i 'http://localhost:7557/devices/202BC1-BM632w-000001'

Примечание:
Удаленное устройство будет зарегистрировано снова при следующем сеансе связи с ACS (например, при следующем периодическом информировании).
POST /devices/<device_id>/tags/<tag>


Позволяет назначить устройству тег. Если тег уже существует, команда не влияет на устройство.
device_id: Уникальный идентификатор устройства.
tag: Тег, который необходимо назначить.
Пример:

 Назначить устройству тег "testing":

 curl -i 'http://localhost:7557/devices/202BC1-BM632w-000000/tags/testing' -X POST
DELETE /devices/<device_id>/tags/<tag>

Позволяет удалить тег с устройства.
device_id: Уникальный идентификатор устройства.
tag: Тег, который необходимо удалить.
Пример:

 Удалить тег "testing" с устройства:
 curl -i 'http://localhost:7557/devices/202BC1-BM632w-000000/tags/testing' -X DELETE

Работа с пресетами
PUT /presets/<preset_name>

Позволяет создать или обновить набор предустановленных параметров (preset).
Запрос возвращает код состояния 200, если предустановка была успешно добавлена или обновлена.
Тело запроса должно содержать JSON-представление предустановки.
О формате предустановок см. раздел "Пресеты" ниже.
preset_name: Имя предустановки.
Пример:

 Создать предустановку для установки интервала информирования 5 минут для всех устройств с тегом "test":


 JSON
{
  "weight": 0,
  "precondition": "{\"_tags\": \"test\"}",
  "configurations": [
    {
      "type": "value",
      "name": "InternetGatewayDevice.ManagementServer.PeriodicInformEnable",
      "value": "true"
    },
    {
      "type": "value",
      "name": "InternetGatewayDevice.ManagementServer.PeriodicInformInterval",
      "value": "300"
    }
  ]
}


 Запрос на создание предустановки можно выполнить с помощью команды curl:


 curl -i 'http://localhost:7557/presets/inform' \
-X PUT \
--data '{"weight": 0, "precondition": "{\"_tags\": \"test\"}", "configurations": [{"type": "value", "name": "InternetGatewayDevice.ManagementServer.PeriodicInformEnable", "value": "true"}, {"type": "value", "name": "InternetGatewayDevice.ManagementServer.PeriodicInformInterval", "value": "300"}]}'


DELETE /presets/<preset_name>


 Позволяет удалить предустановку.

 Пример:

 Удалить предустановку "inform":


 curl -i 'http://localhost:7557/presets/inform' -X DELETE

Работа с файлами
PUT /files/<file_name>

Позволяет загрузить новый файл или перезаписать существующий.
Запрос возвращает код состояния 200, если файл был успешно добавлен или обновлен.
Содержимое файла должно быть отправлено в теле запроса.
file_name: Имя загружаемого файла.
Вместе с файлом можно отправить следующие метаданные в заголовках запроса:


fileType: Для образов прошивки должно быть "1 Firmware Upgrade Image" (Обновление прошивки).
oui: OUI модели устройства, которому принадлежит этот файл (OUI - уникальный идентификатор организации).
productClass: Класс продукта устройства.
version: Для образов прошивки - версия прошивки.
Пример:
 Загрузить файл образа прошивки:
curl -i 'http://localhost:7557/files/new_firmware_v1.0.bin' \
-X PUT \
--data-binary @"./new_firmware_v1.0.bin" \
--header "fileType: 1 Firmware Upgrade Image" \
--header "oui: 123456" \
--header "productClass: ABC" \
--header "version: 1.0"


DELETE /files/<file_name>


Удалить загруженный ранее файл
curl -i 'http://localhost:7557/files/new_firmware_v1.0.bin' -X DELETE



GET /files/

Получает все ранее загруженные файлы.
GET /files/?query={"filename":"<filename>"}

Находит файлы с помощью запроса
Задачи

1. getParameterValues
Задача: Получение значений заданных параметров из CPE.
Структура объекта:
name: "getParameterValues" (обязательно)
parameterNames: Массив строк, представляющих полный путь к параметрам, которые необходимо получить (обязательно).
query = {
  "name": "getParameterValues",
  "parameterNames": [
    "InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANIPConnectionNumberOfEntries",
    "InternetGatewayDevice.Time.NTPServer1", "InternetGatewayDevice.Time.Status"
  ]
}
curl -i 'http://localhost:7557/devices/00236a-96318REF-SR360NA0A4%252D0003196/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name": "getParameterValues", "parameterNames": ["InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANIPConnectionNumberOfEntries", "InternetGatewayDevice.Time.NTPServer1", "InternetGatewayDevice.Time.Status"] }'

За раз можно запрашивать как один, так и несколько параметров
Получить обновленный объект CPE, чтобы получить доступ к запрошенным вами значениям параметров из объекта JSON
query = {"_id": "00236a-96318REF-SR360NA0A4%2D0003196"}
curl -i 'http://localhost:7557/devices/?query=%7B%22_id%22%3A%2200236a-96318REF-SR360NA0A4%252D0003196%22%7D'

2. refreshObject
Задача: Обновляет указанный объект на CPE, возможно, получая последние значения.
Структура объекта:
name: "refreshObject" (обязательно)
objectName: Строка, представляющая полный путь к обновляемому объекту (обязательно).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name": "refreshObject", "objectName": "InternetGatewayDevice.WANDevice.1.WANConnectionDevice"}'

3. setParameterValues
Задача: Устанавливает значения заданных параметров на CPE.
Структура объекта:
name: "setParameterValues" (обязательно)
parameterValues: Массив массивов. Каждый внутренний массив содержит два элемента:
Полный путь к параметру как строка (обязательно).
Новое значение для параметра (может быть логическим, строковым и т. д., в зависимости от параметра).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name": "setParameterValues", "parameterValues": [["InternetGatewayDevice.ManagementServer.UpgradesManaged",false]]}'

Для нескольких значений
{
  name: "setParameterValues",
  parameterValues: [["InternetGatewayDevice.ManagementServer.UpgradesManaged", false], ["InternetGatewayDevice.Time.Enable", true], ["InternetGatewayDevice.Time.NTPServer1", "pool.ntp.org"]]
}

4. addObject
Задача: Добавляет новый объект в конфигурацию CPE.
Структура объекта:
name: "addObject" (обязательно)
objectName: Строка, представляющая полный путь к новому объекту (обязательно).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name":"addObject","objectName":"InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection"}'

5. deleteObject
Задача: Удаляет существующий объект из конфигурации CPE.
Структура объекта:
name: "deleteObject" (обязательно)
objectName: Строка, представляющая полный путь к удаляемому объекту (обязательно).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name":"deleteObject","objectName":"InternetGatewayDevice.WANDevice.1.WANConnectionDevice.1.WANPPPConnection.1"}'

6. reboot
Задача: Перезагружает CPE-устройство.
Структура объекта:
name: "reboot" (обязательно) (дополнительные аргументы не требуются).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name": "reboot"}'

7. factoryReset
Задача: Выполняет сброс настроек к заводским на CPE-устройстве, стирая конфигурацию.
Структура объекта:
name: "factoryReset" (обязательно) (дополнительные аргументы не требуются).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name": "factoryReset"}'

8. download
Задача: Загружает файл с CPE.
Структура объекта:
name: "download" (обязательно)
file: Строка, представляющая имя файла для загрузки (обязательно).
curl -i 'http://localhost:7557/devices/00236a-SR552n-SR552NA084%252D0003269/tasks?timeout=3000&connection_request' \
-X POST \
--data '{"name": "download", "file": "mipsbe-6-42-lite.xml"}'


Предустановки в управлении CPE
Что такое предустановки?
Предустановки определяют правила, которые запускают действия конфигурации на устройствах CPE. Они состоят из трех ключевых компонентов:
Предварительное условие: Это строка JSON, действующая как фильтр. Она определяет, соответствует ли конкретное устройство критериям для применения предустановки. Примеры предварительных условий включают проверку значений параметров или их сравнение с операторами, такими как $gt (больше), $lt (меньше), $gte (больше чем или равно), $lte (меньше чем или равно), $ne (не равно)
Расписание (необязательно): Вы можете дополнительно определить расписание (с использованием выражения cron) для того, когда предустановка должна применяться к совпадающим устройствам. Это позволяет автоматизировать конфигурацию в определенное время.
* * * * *: Запускать задачу каждую секунду.
0 0 12 * *: Запускать задачу в 12:00 каждый день.
0 15 10 * * ?: Запускать задачу в 10:15 10-го числа каждого месяца.
0 */15 * * * ?: Запускать задачу каждые 15 минут.
0 0 0 * * SUN: Запускать задачу в полночь каждое воскресенье.
3600 0 3 * * 1-5 : Запускать задачу каждое утро с 3:00 до 4:00 по будням с понедельника по пятницу.
Специальные символы:
*: Заменяет все возможные значения в поле.
/: Указывает диапазон. Например, 10-20 означает от 10 до 20.
,: Перечисляет значения. Например, MON,WED,FRI означает понедельник, среду и пятницу.
-: Диапазон с шагом. Например, 1-5/2 означает 1, 3, 5.
L: Последний день месяца. Например, * * * L * ? означает последний день каждого месяца.
События (необязательно): События
События TR-069, которые будут запускать пресет. Если события не указаны, то пресет будет оцениваться каждый раз, когда CPE общается с ACS. Если имена событий указаны, все они должны присутствовать. Чтобы исключить событие, добавьте - перед названием события.
{"param": "value"}
{"param": value", "param2": {"$ne": "value2"}}

Имя
Описание
0 BOOTSTRAP
Первая загрузка. Также происходит после сброса настроек до заводских. Обычно сопровождается событием 1 BOOT.
1 BOOT
Устройство CPE было включено или перезагружено.
2 PERIODIC
Периодическое сообщение от CPE. Интервал задается в InternetGatewayDevice.ManagementServer.PeriodicInformInterval.
4 VALUE CHANGE
Код события присутствует, если с момента последнего сообщения изменился какой-либо из параметров активного или пассивного уведомления.
6 CONNECTION REQUEST
Сеанс был установлен по запросу ACS (сервера управления доступом).
7 TRANSFER COMPLETE
Появляется при успешной загрузке или скачивании файла устройством CPE. Например, загрузка обновления прошивки или конфигурации.
8 DIAGNOSTICS COMPLETE
Используется при восстановлении соединения с ACS после завершения диагностического теста, инициированного ACS.
9 REQUEST DOWNLOAD
Указывает, что сеанс был предназначен для вызова метода RequestDownload устройством CPE.
M Reboot
Перезагрузка устройства CPE по запросу ACS.
M Download
Загрузка контента, ранее запрошенная ACS с помощью метода Download. Также должно присутствовать событие 7 TRANSFER COMPLETE.


Пример
1 BOOT, -0 BOOTSTRAP: Срабатывает при загрузке CPE, но не при первом запуске (BOOTSTRAP)
Варианты конфигурации в предустановках
После того, как предустановка применяется к устройству, она может выполнять различные действия конфигурации:
Обновления значений: Измените значения конкретных параметров на устройстве с помощью опции "type": "value".
[
  {
    "type": "value",
    "name": "InternetGatewayDevice.ManagementServer.PeriodicInformEnable",
    "value": "true"
  },
  {
    "type": "value",
    "name": "InternetGatewayDevice.ManagementServer.PeriodicInformInterval",
    "value": "300"
  },


Удаление объектов: Удалите объекты из конфигурации устройства с помощью опции "type": "delete_object".
{
    "type": "delete_object",
    "name": "object_parent",
    "object": "object_name"
  },


Добавление объектов: Добавьте новые объекты в конфигурацию устройства с помощью опции "type": "add_object".
{
    "type": "add_object",
    "name": "object_parent",
    "object": "object_name"
  },


Выполнение скрипта провижининга: Запустите выполнение предопределенного скрипта провижининга с помощью опции "type": "provision".
{
    "type": "provision",
    "name": "YourProvisionName"
  },
]


Сценарии провижининга
Скрипты провижининга - это отдельные сущности, содержащие код JavaScript. Они определяют конкретные действия, которые должны быть предприняты на устройстве, когда предустановка запускает их выполнение.
Управление предустановками
Вот краткий обзор управления предустановками с помощью команд cURL:
Создание предустановки: Используйте запрос PUT с кодом JavaScript предустановки в качестве тела запроса.
curl -X PUT -i 'http://localhost:7557/provisions/mynewprovision' --data 'log("Provision started at " + now);'

Удаление предустановки: Используйте запрос DELETE, чтобы удалить конкретную предустановку.
curl -X DELETE -i 'http://localhost:7557/provisions/mynewprovision'


Получение всех предустановок: Используйте запрос GET, чтобы получить список всех доступных предустановок.
curl -X GET -i 'http://localhost:7557/provisions/'

В целом, предустановки являются мощным инструментом для автоматизации управления устройствами CPE. Сочетая предварительные условия, расписания, события и параметры конфигурации, вы можете добиться динамичных и эффективных рабочих процессов конфигурации.
Аутентификация CPE
Этот раздел описывает процесс аутентификации между CPE-устройствами (Customer Premises Equipment) и системой управления ACS (Auto-Configuration Server).
Аутентификация CPE-ACS
По умолчанию: GenieACS принимает любое входящее соединение по HTTP/HTTPS и отвечает на него.
Параметры аутентификации:
Username (Имя пользователя):
Device.ManagementServer.Username
или
InternetGatewayDevice.ManagementServer.Username
Password (Пароль):
Device.ManagementServer.Password
или
InternetGatewayDevice.ManagementServer.Password (Пароль скрыт, но его можно установить)
Включение аутентификации CPE-ACS
Аутентификацию CPE-ACS можно настроить в веб-интерфейсе GenieACS с помощью опции "Config" на вкладке "Admin".
Перейдите на страницу "Admin" -> "Config".
Нажмите кнопку "New config" внизу страницы.
Откроется всплывающее окно, где вам нужно будет заполнить ключ и значение.
Ключ: cwmp.auth
Значение: принимает логическое значение (true/false)
true: GenieACS принимает любое входящее соединение.
false: GenieACS отклоняет все входящие соединения.
Дополнительная настройка аутентификации
Для более тонкой настройки аутентификации можно использовать функции AUTH() и EXT().
Функция AUTH()
AUTH() принимает два параметра: username (имя пользователя) и password (пароль).
Она проверяет предоставленные данные аутентификации с поступившим запросом, чтобы определить, возвращать true или false.
Пример базового использования:


AUTH("fixed-username", "fixed-password")

GenieACS будет принимать только входящие запросы, аутентифицированные с помощью "fixed-username" и "fixed-password".
Можно ссылаться на различные параметры устройства внутри выражения cwmp.auth.


AUTH(Device.ManagementServer.Username, Device.ManagementServer.Password)

GenieACS будет проверять соответствие имени пользователя и пароля, полученных из запроса, значениям параметров устройства Device.ManagementServer.Username 
и 
Device.ManagementServer.Password.
Функция EXT()
EXT() позволяет вызывать внешний скрипт из выражения аутентификации.
Это можно использовать для получения учетных данных из внешнего источника.


AUTH(DeviceID.SerialNumber, EXT("authenticate", "getPassword", DeviceID.SerialNumber))

В этом примере GenieACS будет использовать для аутентификации:
Имя пользователя: значение параметра DeviceID.SerialNumber устройства.
Пароль: результат выполнения внешнего скрипта authenticate с функцией getPassword и параметром DeviceID.SerialNumber.

